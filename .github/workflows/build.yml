name: Build FFmpeg (macOS ARM64 static)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - '*'
    paths-ignore:
      - '**.md'
  pull_request:
    paths-ignore:
      - '**.md'

jobs:
  build:
    runs-on: macos-14
    env:
      CFLAGS:  "-arch arm64"
      LDFLAGS: "-arch arm64"
      PREFIX:  "${{ github.workspace }}/ffmpeg_build"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Homebrew & tools
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          brew install nasm pkg-config yasm

      - name: Clone FFmpeg source (default branch)
        run: git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg

      - name: Configure & build FFmpeg (fully static, no X11/libxcb)
        working-directory: ffmpeg
        run: |
          ./configure \
            --prefix="$PREFIX" \
            --disable-shared \
            --enable-static \
            --disable-debug \
            --enable-pic \
            --disable-doc \
            --disable-ffplay \
            --disable-avdevice \
            --disable-devices \
            --disable-indevs \
            --disable-outdevs \
            --disable-libxcb \
            --disable-libxcb-shm \
            --disable-libxcb-xfixes \
            --disable-libfreetype \
            --disable-libfontconfig \
            --disable-indev=qtkit \
            --disable-indev=x11grab \
            --disable-indev=x11grab_xcb \
            --disable-indev=qtkit \
            --disable-xlib \
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Strip & verify
        run: |
          strip "$PREFIX/bin/ffmpeg"
          otool -L "$PREFIX/bin/ffmpeg"   # should no longer reference /opt/homebrew/opt/libX11/lib/libX11.6.dylib

      - name: Package artifact
        run: zip -j FFmpeg-static-arm64.zip "$PREFIX/bin/ffmpeg"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FFmpeg-static-arm64
          path: FFmpeg-static-arm64.zip
