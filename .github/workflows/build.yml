name: Build FFmpeg (macOS ARM64 static)

on:
  push:
    branches:
      - main
      - master
    tags:
      - '*'
    paths-ignore:
      - '**.md'
  pull_request:
    paths-ignore:
      - '**.md'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14-arm64
    strategy:
      matrix:
        include:
          - tag: latest

    env:
      CFLAGS:  "-arch arm64"
      LDFLAGS: "-arch arm64"
      PREFIX:  "${{ github.workspace }}/ffmpeg_build"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Homebrew & tools
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          brew install nasm pkg-config yasm

      - name: Clone FFmpeg source (default branch)
        run: git clone --depth 1 https://github.com/FFmpeg/FFmpeg.git ffmpeg

      - name: Configure & build FFmpeg (static)
        working-directory: ffmpeg
        run: |
          ./configure \
            --prefix="$PREFIX" \
            --disable-shared \
            --enable-static \
            --disable-debug \
            --enable-pic \
            --disable-doc \
            --disable-ffplay      # skip ffplay, only build the ffmpeg CLI
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Strip & verify
        run: |
          strip "$PREFIX/bin/ffmpeg"
          otool -L "$PREFIX/bin/ffmpeg"   # should only reference system dylibs

      - name: Package artifact
        run: zip -j FFmpeg-${{ matrix.tag }}-arm64-static.zip "$PREFIX/bin/ffmpeg"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FFmpeg-${{ matrix.tag }}-arm64-static
          path: FFmpeg-${{ matrix.tag }}-arm64-static.zip

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: FFmpeg-${{ matrix.tag }}-arm64-static.zip
