name: Build FFmpeg (macOS ARM64 static)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - '*'
    paths-ignore:
      - '**.md'
  pull_request:
    paths-ignore:
      - '**.md'

jobs:
  build:
    name: Build-FFmpeg-${{ matrix.tag }}-arm64
    runs-on: macos-14          # M1-powered ARM64 runner
    strategy:
      matrix:
        include:
          - tag: 3.6.0

    env:
      # ensure all C/C++ builds target arm64
      CFLAGS:  "-arch arm64"
      LDFLAGS: "-arch arm64"
      # install prefix
      PREFIX:  "${{ github.workspace }}/ffmpeg_build"

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Install Homebrew & tools
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          brew install nasm pkg-config yasm

      - name: Clone FFmpeg source
        run: |
          git clone --depth 1 --branch ${{ matrix.tag }} https://github.com/FFmpeg/FFmpeg.git ffmpeg

      - name: Configure FFmpeg (static)
        working-directory: ffmpeg
        run: |
          ./configure \
            --prefix="$PREFIX" \
            --disable-shared \
            --enable-static \
            --disable-debug \
            --enable-pic \
            --disable-doc \
            --disable-programs                # only build libraries; we'll build the ffmpeg binary next
          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Build ffmpeg binary
        run: |
          # Link against the static libs we just installed
          gcc $CFLAGS $LDFLAGS \
            -o ffmpeg \
            ffmpeg/tools/ffmpeg.c \
            -I"$PREFIX/include" \
            -L"$PREFIX/lib" -lavformat -lavcodec -lavutil -lswresample -lswscale

      - name: Strip and verify
        run: |
          strip ffmpeg
          otool -L ffmpeg   # should only list system dylibs

      - name: Package artifact
        run: zip -j FFmpeg-${{ matrix.tag }}-arm64-static.zip ffmpeg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FFmpeg-${{ matrix.tag }}-arm64-static
          path: FFmpeg-${{ matrix.tag }}-arm64-static.zip
          
